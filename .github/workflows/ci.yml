name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_acceptance_tests:
        description: 'Run acceptance tests'
        required: false
        default: 'false'

jobs:
  build-and-unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - run: go build ./...

      - run: go test ./... -short -v

      - name: Install dotenv-linter
        run: curl -sSfL https://raw.githubusercontent.com/dotenv-linter/dotenv-linter/master/install.sh | sh -s

      - name: Lint .env files
        run: ./bin/dotenv-linter check --ignore-checks UnorderedKey .env.example

  acceptance-test:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.run_acceptance_tests == 'true')
    needs: build-and-unit-test
    environment: jira-test
    env:
      TF_ACC: "1"
      JIRA_SITE_URL: ${{ secrets.JIRA_SITE_URL }}
      JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_TEST_PROJECT_ID: ${{ secrets.JIRA_TEST_PROJECT_ID }}
      JIRA_WEBHOOK_USER: ${{ secrets.JIRA_WEBHOOK_USER }}
      JIRA_WEBHOOK_TOKEN: ${{ secrets.JIRA_WEBHOOK_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - run: go test ./... -v -timeout 120m
